<!doctype html><html lang=en><head><title>热点账户处理 - hello world</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="stay foolish, stay hungry"><meta name=author content="sunpeng"><meta name=baidu-site-verification content="vWQN0uJLC2"><meta property="og:title" content="热点账户处理"><meta property="og:description" content="互联网交易中，当某一商家交易量大的时候，商家对应的账户更新的比较频繁，该商家对应的账户记录会变成热点行，该商家的账户就是热点账户。通常热点账户会导致各种系统问题，对数据库也会造成很大压力。"><meta property="og:type" content="article"><meta property="og:url" content="https://sunpe.github.io/posts/2020-09-26-hot-account/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-26T22:00:00+08:00"><meta property="article:modified_time" content="2020-09-26T22:00:00+08:00"><meta name=generator content="Hugo 0.106.0"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://sunpe.github.io/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://sunpe.github.io/css/styles.css></head><body><div id=container><header><h1><a href=https://sunpe.github.io/>hello world</a></h1><ul id=social-media></ul><p><em>stay foolish, stay hungry</em></p></header><nav><ul><li><a href=https://sunpe.github.io/><i class="fa-li fa fa-lg"></i><span>Home</span></a></li><li><a href=https://sunpe.github.io/posts/><i class="fa-li fa fa-lg"></i><span>Posts</span></a></li><li><a href=https://sunpe.github.io/tags/><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li><li><a href=https://sunpe.github.io/categories/><i class="fa-li fa fa-lg"></i><span>Categories</span></a></li><li><a href=https://sunpe.github.io/about/><i class="fa-li fa fa-lg"></i><span>About</span></a></li></ul></nav><main><article><h1>热点账户处理</h1><aside><ul><li><time class=post-date datetime=2020-09-26T22:00:00+08:00>Sep 26, 2020</time></li><li>Categories:
<em><a href=https://sunpe.github.io/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1>系统设计</a></em></li><li>Tags:
<em><a href=https://sunpe.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1>#系统设计</a></em></li><li>One minute read</li></ul></aside><div class=featured_image><a href=https://sunpe.github.io/posts/2020-09-26-hot-account/ title=热点账户处理><img src></a></div><p>互联网交易中，当某一商家交易量大的时候，商家对应的账户更新的比较频繁，该商家对应的账户记录会变成热点行，该商家的账户就是热点账户。通常热点账户会导致各种系统问题，对数据库也会造成很大压力。</p><h2 id=热点账户分类>热点账户分类</h2><p>根据资金流动的方向可以把热点账户分为「加频账户」、「减频账户」和「双频账户」。 其中「加频账户」是指资金流入比较频繁的账户，比如商家的收款账户；「减频账户」是指资金流出比较频繁的账户，比如商家的退款账户；「双频账户」指流入和流出都比较频繁的账户，比如商家在电商平台开设的内部户。</p><h2 id=热点账户识别>热点账户识别</h2><p>在交易系统中可以通过提前配置、 实时统计和同步的方式来识别热点账户。历史的热点账户可以提前配置到系统中，在交易过程中可以利用流式计算的思路实时统计账户请求量，当请求量达到阈值将账户信息同步到系统的热点账户名单中。系统整体架构如图 1 所示。</p><p><img src=https://sunpe.github.io/images/hot_account/1.png alt>
图 1</p><h2 id=热点账户问题解决方案>热点账户问题解决方案</h2><h3 id=1-限流>1. 限流</h3><p>热点账户问题的根源是大量请求并发竞争账户的操作权，账户的操作权是稀缺资源，所以我们可以减少单位时间内对账户的操作次数，所以「限流」通常是最直接有效的解决方式。限流简单来说就是超出我能力范围的不处理。如图 2 所示。</p><p><img src=https://sunpe.github.io/images/hot_account/2.png alt>
图 2</p><p>虽然限流能明显减少对账户的操作，但限流是通过拒绝交易来达到目的，通常会影响客户体验，这种方式通常作为系统保障的兜底措施。</p><h3 id=2-缓冲>2. 缓冲</h3><p>缓冲的方式就是同步转异步来处理交易请求。互联网交易热点通常具有瞬时性，可以先把请求接下来，比如缓冲到消息队列中，并将结果返回给调用方。然后在从消息队列中取出交易数据进行处理，借助消息队列的「削峰填谷」的特性来消除瞬时的热点。如图 3 所示。</p><p><img src=https://sunpe.github.io/images/hot_account/3.png alt>
图 3</p><p>但缓冲的方式可能会导致请求大量积压，如果积压的量超过日处理能力的上限，可能会导致循环积压的问题。由于缓冲队列消费不及时可能会导致账户金额更新不及时，这种情况下可以采用全局缓存来缓存账户信息，将数据放到缓冲队列前，先更新缓存中账户数据。这种方式比较适合处理瞬时的热点数据。</p><h3 id=3-合并请求数据>3. 合并请求数据</h3><p>我们还可以合并用户的请求的方式来削减单位时间内对账户的操作次数。先将明细数据保存下来，然后使用单独的 worker 来汇总明细数据，并更新账户数据。如图 4 所示。</p><p><img src=https://sunpe.github.io/images/hot_account/4.png alt>
图 4</p><p>这种方式也会造成账户数据更新上的延迟，同样可以采用全局缓存的方式来缓存账户信息，保存明细数据的同时更新缓存中的账户信息。</p><h3 id=4-分治>4. 分治</h3><p>账户的操作权是稀缺资源，除了减少账户操作次数这一思路之外，我们还可以利用分治的思想，给主账户创建多个影子账户，将主账户的资金分散到影子账户中，通过一定的路由规则，将交易请求发送到不同的影子账户上。如图 5 所示。</p><p><img src=https://sunpe.github.io/images/hot_account/5.png alt>
图 5</p><p>这种方式带来的问题是，如何来平衡影子账户的资金和如果账户资金不足要扣减多个账户的时候怎么处理。</p><h3 id=缓存>缓存</h3><p>缓存是高并发系统的又一大利器，在以上方案中也有缓存的应用，总体思路是将账户数据同步到缓存中，缓存数据异步刷新到数据库中。这种方式需要考虑缓存和数据库数据一致性的问题，如果发生数据不一致的情况，可能需要根据明细数据进行对账操作。</p><h2 id=总结>总结</h2><p>处理热点账户的问题需要根据具体业务和应用场景来具体处理，选择合适的解决方案，最重要的是需要保证账户数据的一致性。</p></article><section class=post-nav><ul><li><a href=https://sunpe.github.io/posts/2020-09-04-golang-memory-analyst/><i class="fa fa-chevron-circle-left"></i> golang 语言机制之内存剖析</a></li><li><a href=https://sunpe.github.io/posts/2020-10-17-make-sure-goroutine-willstop/>开启goroutine前确保goroutine可以退出 <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><ul><li><h6>Copyright © 2022 - sunpeng |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://sunpe.github.ioindex.xml>Subscribe</a></h6></li></ul></footer></div><script src=https://sunpe.github.io/js/scripts.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-161915530-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script id=baidu_analytics>var _hmt=_hmt||[];(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.async=!0,e.src="https://hm.baidu.com/hm.js?567e1c9bcb80e3b8c4f1c1dbf8bb9fab",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script id=baidu_push>(function(){if(window.location.hostname==="localhost")return;var t,n,e=document.createElement("script");e.async=!0,n=window.location.protocol.split(":")[0],n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>